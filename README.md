# SpatialOS SDK for Rust

[![Build Status](https://travis-ci.org/jamiebrynes7/spatialos-sdk-rs.svg?branch=master)](https://travis-ci.org/jamiebrynes7/spatialos-sdk-rs) [![dependency status](https://deps.rs/repo/github/jamiebrynes7/spatialos-sdk-rs/status.svg)](https://deps.rs/repo/github/jamiebrynes7/spatialos-sdk-rs) ![Rustc Version](https://img.shields.io/badge/rustc-1.31-blue.svg)


> This is an **unoffical**, **unsupported**, and **untested** integration of the [SpatialOS SDK C API bindings](https://docs.improbable.io/reference/13.3/capi/introduction) with Rust. Improbable does not officially support Rust as a worker language.

This is still heavily WIP and should be treated as such. Progress can be seen in the `Projects` boards which define milestones and progress toward those milestones. When this reaches feature parity with the C API and has basic code generation in which all user facing APIs are safe, a crate will be published to `crates.io`.

## Setup

1. Clone this repository.
2. Run `cargo run --bin download_sdk -- -d dependencies -s 13.5.1` to download the C API dependencies.
3. Set the `SPATIAL_LIB_DIR` environment variable to the location of the dependencies: `export SPATIAL_LIB_DIR=$(pwd)/dependencies`.
4. Run `cargo build`

If these steps complete successfully, the `spatialos-sdk` crate has been built and linked successfully and can be used in user code.

## Running the Example Project

To run the example project, you will need to:

1. Build a release version of the RustWorker - `cargo build --example project-example --release`.
2. Navigate to `spatialos-sdk/examples/project-example/spatialos`.
2. Build the schema descriptor for Spatial - `cargo run --bin setup -- ./schema/bin --schema-path ./schema`
3. Run the code generator - `cargo run --bin generator ./schema/bin/bundle.json ../generated_code.rs`
4. In two terminals:
   - Navigate to the `spatialos` directory and start spatial: `cd spatialos-sdk/examples/project-example/spatialos/ && spatial local launch`
   - Run the example project worker - `cargo run --example project-example -- receptionist --worker_type RustWorker`

## Testing the code generator

To run the code generator tests, run the following:

```
cargo test -p spatialos-sdk-code-generator
```

To display Rusts autogenerated debug representation of the schema bundle, run the following:

```
cargo test -p spatialos-sdk-code-generator -- --nocapture
```

### Updating Rust bindings

To update the Rust bindings found in `spatialos-sdk-sys` run the following command from the root of the repository:

```bash
cargo run --bin generate_bindings -- -i ./dependencies/win/include/improbable/ -o ./spatialos-sdk-sys/src/
```

Note that this depends on `bindgen` which has `clang` as a dependency. See [here](https://rust-lang.github.io/rust-bindgen/requirements.html) for more info.
